(window.webpackJsonp=window.webpackJsonp||[]).push([[76],{513:function(s,n,t){"use strict";t.r(n);var a=t(11),e=Object(a.a)({},(function(){var s=this,n=s.$createElement,t=s._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"哨兵模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#哨兵模式"}},[s._v("#")]),s._v(" 哨兵模式")]),s._v(" "),t("h2",{attrs:{id:"前置概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前置概念"}},[s._v("#")]),s._v(" 前置概念")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("名词")]),s._v(" "),t("th",[s._v("逻辑结构")]),s._v(" "),t("th",[s._v("物理结构")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("主节点(master)")]),s._v(" "),t("td",[s._v("redis主库")]),s._v(" "),t("td",[s._v("一个独立的redis进程")])]),s._v(" "),t("tr",[t("td",[s._v("从节点(slave)")]),s._v(" "),t("td",[s._v("redis从库")]),s._v(" "),t("td",[s._v("一个独立的redis进程")])]),s._v(" "),t("tr",[t("td",[s._v("Redis数据节点")]),s._v(" "),t("td",[s._v("主节点和从节点")]),s._v(" "),t("td",[s._v("主节点和从节点进程")])]),s._v(" "),t("tr",[t("td",[s._v("Sentinel节点")]),s._v(" "),t("td",[s._v("监控redis数据节点")]),s._v(" "),t("td",[s._v("一个独立的sentinel进程")])]),s._v(" "),t("tr",[t("td",[s._v("Sentinel节点集合")]),s._v(" "),t("td",[s._v("若干个sentinel节点的抽象组合")]),s._v(" "),t("td",[s._v("若干sentinel节点进程")])]),s._v(" "),t("tr",[t("td",[s._v("Redis Sentinel")]),s._v(" "),t("td",[s._v("redis高可用解决方案")]),s._v(" "),t("td",[s._v("sentinel节点集合和redis数据节点进程")])]),s._v(" "),t("tr",[t("td",[s._v("应用方")]),s._v(" "),t("td",[s._v("一个或多个客户端")]),s._v(" "),t("td",[s._v("一个或多个客户端进程")])])])]),s._v(" "),t("h2",{attrs:{id:"_1-主从复制的问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-主从复制的问题"}},[s._v("#")]),s._v(" 1. 主从复制的问题")]),s._v(" "),t("h3",{attrs:{id:"_1-1-什么是主从复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-什么是主从复制"}},[s._v("#")]),s._v(" 1.1 什么是主从复制？")]),s._v(" "),t("blockquote",[t("p",[s._v("启动两个独立的redis进程，一个为主节点另一个为从节点。在主从复制模式下，可以将主节点的数据改变同步给从节点")])]),s._v(" "),t("p",[t("strong",[s._v("优点")])]),s._v(" "),t("ul",[t("li",[s._v("从节点作为备份，当主节点出现故障时，可以顶替主节点，尽力保证数据不丢失。")]),s._v(" "),t("li",[s._v("一旦主节点不能支撑大并发量的读操作，从节点可以分担主节点读压力")])]),s._v(" "),t("p",[t("strong",[s._v("缺点")])]),s._v(" "),t("ul",[t("li",[s._v("需要手动晋升为主节点，需要修改应用方的主节点地址，还需要命令其他从节点去复制新的主节点")]),s._v(" "),t("li",[s._v("主节点性能受单机的限制")]),s._v(" "),t("li",[s._v("主节点的存储能力受单机的限制")])]),s._v(" "),t("h3",{attrs:{id:"_1-2-高可用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-高可用"}},[s._v("#")]),s._v(" 1.2 高可用")]),s._v(" "),t("p",[t("strong",[s._v("如何进行故障转移")])]),s._v(" "),t("ul",[t("li",[s._v("如果主节点无法正常启动，需要一个从节点对其执行salveof no one命令使其成为主节点")]),s._v(" "),t("li",[s._v("原来的从节点成为主节点后，更新应用方的主节点信息")]),s._v(" "),t("li",[s._v("其他从节点去复制新的主节点")]),s._v(" "),t("li",[s._v("待原来的主节点恢复后，让它去复制新的注解")])]),s._v(" "),t("p",[t("strong",[s._v("缺点")])]),s._v(" "),t("ul",[t("li",[s._v("一旦出现节点故障，需要人工干预进行故障转移")]),s._v(" "),t("li",[s._v("应用方无法即时感知到主节点的变化，从而造成一定的写数据丢失和读数据错误")])]),s._v(" "),t("h2",{attrs:{id:"_2-redis-sentinel的高可用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-redis-sentinel的高可用"}},[s._v("#")]),s._v(" 2. Redis Sentinel的高可用")]),s._v(" "),t("blockquote",[t("p",[s._v("Redis Sentinel是一个分布式架构，其中包含若干个Sentinel节点和Redis数据节点，每个Sentinel节点会对数据节点和其他Sentinel节点监控")])]),s._v(" "),t("p",[t("strong",[s._v("特性")])]),s._v(" "),t("ul",[t("li",[s._v("自动完成故障发现")]),s._v(" "),t("li",[s._v("自动进行故障转移")])]),s._v(" "),t("p",[t("strong",[s._v("具体操作")])]),s._v(" "),t("ul",[t("li",[s._v("当发现节点不可达时，会对节点做下线标识")]),s._v(" "),t("li",[s._v("当被标识的节点是主节点时，它会和其他Sentinel节点进行协商(多数同意)，然后选举出一个Sentinel节点完成自动故障转移的工作，同时通知给应用方")])]),s._v(" "),t("h2",{attrs:{id:"_3-部署和安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-部署和安装"}},[s._v("#")]),s._v(" 3. 部署和安装")]),s._v(" "),t("h3",{attrs:{id:"_3-1-部署数据节点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-部署数据节点"}},[s._v("#")]),s._v(" 3.1 部署数据节点")]),s._v(" "),t("p",[t("strong",[s._v("配置文件")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1个主节点")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-6379.conf")]),s._v("\nport "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# requirepass xxxxx # 设置密码")]),s._v("\ndaemonize "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\npidfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/run/redis_6379.pid"')]),s._v("\nlogfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/data/redis/log/redis-6379.log"')]),s._v("\ndbfilename "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dump-6379.rdb"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Data/redis/data"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2个从节点")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-6380.conf")]),s._v("\nport "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6380")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# masterauth xxxxx # 主节点密码")]),s._v("\ndaemonize "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\npidfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/run/redis_6380.pid"')]),s._v("\nlogfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Data/redis/log/redis-6380.log"')]),s._v("\ndbfilename "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dump-6380.rdb"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Data/redis/data"')]),s._v("\nslaveof "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-6381.conf")]),s._v("\nport "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6381")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# masterauth xxxxx # 主节点密码")]),s._v("\ndaemonize "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\npidfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/run/redis_6381.pid"')]),s._v("\nlogfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Data/redis/log/redis-6381.log"')]),s._v("\ndbfilename "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dump-6381.rdb"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Data/redis/data"')]),s._v("\nslaveof "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br")])]),t("p",[t("strong",[s._v("启动")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动主节点")]),s._v("\nredis-server redis-6379.conf\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检测")]),s._v("\nredis-cli -h "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" PONG "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动完成")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动从节点")]),s._v("\nredis-server redis-6380.conf\nredis-server redis-6381.conf\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检测")]),s._v("\nredis-cli -h "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("638")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v("\nredis-cli -h "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6381")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" PONG "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动完成")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[t("strong",[s._v("确定主从关系")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主视角")]),s._v("\nredis-cli -h "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" info replication\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Replication")]),s._v("\nrole:slave\nmaster_host:127.0.0.1\nmaster_port:6381\nmaster_link_status:down\nmaster_last_io_seconds_ago:-1\nmaster_sync_in_progress:0\nslave_repl_offset:0\nmaster_link_down_since_seconds:1650439990\nslave_priority:100\nslave_read_only:1\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从视角")]),s._v("\nredis-cli -h "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6380")]),s._v(" info replication\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Replication")]),s._v("\nrole:slave\nmaster_host:127.0.0.1\nmaster_port:6379\nmaster_link_status:up\nmaster_last_io_seconds_ago:5\nmaster_sync_in_progress:0\nslave_repl_offset:224\nslave_priority:100\nslave_read_only:1\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br")])]),t("h3",{attrs:{id:"_3-2-部署sentinel节点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-部署sentinel节点"}},[s._v("#")]),s._v(" 3.2 部署Sentinel节点")]),s._v(" "),t("p",[t("strong",[s._v("配置文件")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /usr/local/redis/sentinel.conf ./\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" sentinel.conf "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" -v "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'#'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" -v "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'^$'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" redis-sentinel-26379.conf\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-sentinel-26379.conf")]),s._v("\nport "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\ndaemonize "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\npidfile /var/run/redis-sentinel-26379.pid\nlogfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Data/redis/log/redis-sentinel-26379.log"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /Data/redis/data\nsentinel monitor mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\t\nsentinel down-after-milliseconds mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\t\t\t\t\nsentinel parallel-syncs mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\t\t\t\t\t\t\t\nsentinel failover-timeout mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("180000")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel auth-pass mymaster xxxxx # 主节点密码")]),s._v("\n\t\t\t\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-sentinel-26380.conf")]),s._v("\nport "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26380")]),s._v("\ndaemonize "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\npidfile /var/run/redis-sentinel-26380.pid\nlogfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Data/redis/log/redis-sentinel-26380.log"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /Data/redis/data\nsentinel monitor mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nsentinel down-after-milliseconds mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\nsentinel parallel-syncs mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nsentinel failover-timeout mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("180000")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel auth-pass mymaster xxxxx # 主节点密码")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-sentinel-26381.conf")]),s._v("\nport "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26381")]),s._v("\ndaemonize "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\npidfile /var/run/redis-sentinel-26381.pid\nlogfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Data/redis/log/redis-sentinel-26381.log"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /Data/redis/data\nsentinel monitor mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nsentinel down-after-milliseconds mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\nsentinel parallel-syncs mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nsentinel failover-timeout mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("180000")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel auth-pass mymaster xxxxx # 主节点密码")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br")])]),t("p",[t("strong",[s._v("启动")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("redis-sentinel redis-sentinel-26379.conf\nredis-sentinel redis-sentinel-26380.conf\nredis-sentinel redis-sentinel-26381.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[t("strong",[s._v("启动后配置变化")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\ndaemonize "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\npidfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/run/redis-sentinel-26379.pid"')]),s._v("\nlogfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Data/redis/log/redis-sentinel-26379.log"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Data/redis/data"')]),s._v("\nsentinel myid 3ee1d97bcb05cecc0d38d85b742f5d814d6b95fe\nsentinel deny-scripts-reconfig "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nsentinel monitor mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nsentinel config-epoch mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nsentinel leader-epoch mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Generated by CONFIG REWRITE")]),s._v("\nprotected-mode no\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 发现两个从节点")]),s._v("\nsentinel known-replica mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6380")]),s._v("\nsentinel known-replica mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6381")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 发现两个sentinel节点")]),s._v("\nsentinel known-sentinel mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26381")]),s._v(" a854b87c13bbf17c73f5c38bbda3ab82ae905d1a\nsentinel known-sentinel mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26380")]),s._v(" 9019b0f763b194fd1ad5f94af61a7a26b2f66fdf\nsentinel current-epoch "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("p",[t("strong",[s._v("确认Sentinel节点关系")])]),s._v(" "),t("blockquote",[t("p",[s._v("Sentinel结点会自动发现从结点和其他Sentinel结点")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("redis-cli -h "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v(" info Sentinel\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Sentinel")]),s._v("\nsentinel_masters:1\nsentinel_tilt:0\nsentinel_running_scripts:0\nsentinel_scripts_queue_length:0\nsentinel_simulate_failure_flags:0\nmaster0:name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mymaster,status"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ok,address"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:6379,slaves"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(",sentinels"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("h3",{attrs:{id:"_3-3-配置参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-配置参数"}},[s._v("#")]),s._v(" 3.3 配置参数")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置监控的主节点 <master-name> <ip> <port> <quorum>")]),s._v("\nsentinel monitor mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  \n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 超时设置，超过这个时间则判定改节点不可达，单位毫秒")]),s._v("\nsentinel down-after-milliseconds mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("    \n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 故障转移时，同时向主节点发起复制的从节点个数")]),s._v("\nsentinel parallel-syncs mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 故障转移超时时间，包括选合适的从节点、从节点晋升主节点、其他节点复制新的主节点、等待原主节点复制新的主节点")]),s._v("\nsentinel failover-timeout mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("180000")]),s._v("       \n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 禁止脚本动态配置")]),s._v("\nsentinel deny-scripts-reconfig "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果sentinel监控的主节点配置了密码，则需要添加")]),s._v("\nsentinel auth-pass      \n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在故障转移期间，当一些警告级别的事件发生，则触发对应路径的脚本")]),s._v("\nsentinel notification-script "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("master-name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("script"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  \n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 参数:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1.主节点名称:master-name ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2.sentinel节点角色:role ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 3.from-ip:原主节点ip ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 4.from-port:原主节点端口 ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 5.to-ip:新>主节点ip ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 6.to-port:新主节点的端口 ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 7.script-path:必须有可执行权限")]),s._v("\nsentinel client-reconfig-script "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("master-name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("script"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("    \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br")])]),t("h2",{attrs:{id:"_4-api"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-api"}},[s._v("#")]),s._v(" 4. API")]),s._v(" "),t("p",[t("strong",[s._v("1. sentinel masters")])]),s._v(" "),t("blockquote",[t("p",[s._v("展示所有被监控的主节点状态以及相关的统计信息")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("redis-cli -h "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\nsentinel masters\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mymaster"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ip"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"port"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6379"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"runid"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3969ddfb7e22218712bc4a2beac9187bba5a489e"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"flags"')]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"master"')]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[t("strong",[s._v("2. sentinel masters (master name)")])]),s._v(" "),t("blockquote",[t("p",[s._v("展示指定master name 的主节点状态以及相关的统计信息")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("sentinel master mymaster\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mymaster"')]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ip"')]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1"')]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"port"')]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6379"')]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"runid"')]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3969ddfb7e22218712bc4a2beac9187bba5a489e"')]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"flags"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"master"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[t("strong",[s._v("3. sentinel slavers (master name)")])]),s._v(" "),t("blockquote",[t("p",[s._v("展示指定master name 的从节点状态以及相关的统计信息")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("sentinel slaves mymaster\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1:6380"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ip"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"port"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6380"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"runid"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b674e1b23fe90132c5923af2cf80eb89060da169"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"flags"')]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"slave"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1:6381"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ip"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"port"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6381"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"runid"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"7b0360797367a2b1053cd103f5009d808cc3344d"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"flags"')]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"slave"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br")])]),t("h3",{attrs:{id:"_5-实现原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-实现原理"}},[s._v("#")]),s._v(" 5. 实现原理")]),s._v(" "),t("h4",{attrs:{id:"_5-1-三个定时任务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-三个定时任务"}},[s._v("#")]),s._v(" 5.1 三个定时任务")]),s._v(" "),t("blockquote",[t("p",[s._v("Redis Sentinel通过三个定时监控任务完成对各个节点发现和监控")])]),s._v(" "),t("p",[t("strong",[s._v("1) 每隔10秒，每隔Sentinel节点会向主节点和从结点发送info命令获取最新的拓扑结构")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("info replication\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Replication")]),s._v("\nrole:master\nconnected_slaves:2\nslave0:ip"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1,port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6380")]),s._v(",state"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("online,offset"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8192")]),s._v(",lag"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nslave1:ip"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1,port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(",state"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("online,offset"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8591")]),s._v(",lag"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nmaster_replid:011883384c243af15a88fb528a48eb9d058b7b2a\nmaster_replid2:0000000000000000000000000000000000000000\nmaster_repl_offset:8591\nsecond_repl_offset:-1\nrepl_backlog_active:1\nrepl_backlog_size:1048576\nrepl_backlog_first_byte_offset:1\nrepl_backlog_histlen:8591\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[t("strong",[s._v("作用")])]),s._v(" "),t("ul",[t("li",[s._v("通过向主节点执行info命令，可以获取从节点信息，从而不需要显示配置从节点")]),s._v(" "),t("li",[s._v("当有新节点加入都可以进行感知")]),s._v(" "),t("li",[s._v("当节点不可达或者故障转移后，可以使用info实时更新节点信息")])]),s._v(" "),t("p",[t("strong",[s._v("2）每隔2秒，每个Sentinel节点会向Redis的数据结点的__sentinel__:hello频道发送Sentinel节点对主节点的判断以及当前Sentinel节点的信息，同时每个Sentinel节点也会订阅改频道，来了解其他Sentinel节点以及它们对主节点的判断")])]),s._v(" "),t("p",[t("strong",[s._v("作用")])]),s._v(" "),t("ul",[t("li",[s._v("发现新的Sentinel节点，了解其他节点信息，如果有新节点加入则保存信息并创建连接")]),s._v(" "),t("li",[s._v("Sentinel节点之间交换主节点的状态，作为后面客观下线以及领导者选举的依据")])]),s._v(" "),t("p",[t("strong",[s._v("3）每隔1秒，每个Sentinel节点会向主节点、从节点、其他Sentinel节点发送一条ping命令做一次心跳检测，来确认这个节点当前是否可达")])]),s._v(" "),t("h4",{attrs:{id:"_5-2-主-客观下线"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-主-客观下线"}},[s._v("#")]),s._v(" 5.2 主/客观下线")]),s._v(" "),t("p",[t("strong",[s._v("1）主观下线")])]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("一家之言，存在误判")])])]),s._v(" "),t("p",[s._v("当前Sentinel节点每隔1s会向数据节点和其他Sentinel节点发送心跳检测，当这些节点超过down-after-milliseconds没有进行回复，就对该节点做失败判定")]),s._v(" "),t("p",[t("strong",[s._v("2）客观下线")])]),s._v(" "),t("p",[s._v("当Sentinel主观下线的节点时主节点时，改Sentinel节点会通过"),t("strong",[s._v("sentinel is-master-down-by-addr")]),s._v("命令向其他Sentinel节点询问对主节点的判断，当超过quronum个数，Sentinel节点认为主节点确实有问题，这是便做出客观下线的决定。")]),s._v(" "),t("h3",{attrs:{id:"_5-3-sentinel领导选举"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-sentinel领导选举"}},[s._v("#")]),s._v(" 5.3 Sentinel领导选举")]),s._v(" "),t("blockquote",[t("p",[s._v("Redis Sentinel使用Raft算法实现领导者选举")])]),s._v(" "),t("p",[s._v("当Sentinel节点对主节点做了客观下线的决定后，并不是立刻进行故障转移，而是Sentinel节点之间会做一个领导者选举的工作，选出一个Sentinel节点作为领导者进行故障转移。")]),s._v(" "),t("p",[t("strong",[s._v("选举大概步骤")])]),s._v(" "),t("ul",[t("li",[s._v("每个S节点都是潜在成为领导的节点，当它确认主节点主观下线时，会向其他S节点发送sentinel is-master-down-by-addr命令来毛遂自荐设置自己为领导者。")]),s._v(" "),t("li",[s._v("收到命令的S节点，如果没有同意其他S节点的毛遂自荐就拒绝，反之同意其请求。")]),s._v(" "),t("li",[s._v("如果该S节点发现自己的票数已经超过max(quornum, num(sentinels) / 2 + 1)，则称为领导者。")]),s._v(" "),t("li",[s._v("如果此轮没有选举出领导者，将进入下一轮选举")])]),s._v(" "),t("p",[s._v("**notes：**每个Sentinel节点只有一次投票权")]),s._v(" "),t("h3",{attrs:{id:"_5-4-故障转移"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-故障转移"}},[s._v("#")]),s._v(" 5.4 故障转移")]),s._v(" "),t("p",[t("strong",[s._v("1）从节点列表中选出一个节点作为新的节点作为新的主节点，选择方法如下")])]),s._v(" "),t("ul",[t("li",[s._v('过滤："不健康(主观下线、断线)" 5秒内没有回复过Sentinel节点ping响应、与主节点失联超过down-after-milliseconds*10秒。')]),s._v(" "),t("li",[s._v("选择salve-priority(从节点优先级)最高的从节点列表，如果存在则返回，不存在则继续。")]),s._v(" "),t("li",[s._v("选择复制偏移量最大的从节点(复制的最完成)，如果存在则返回，不存在则继续。")]),s._v(" "),t("li",[s._v("选择runid最小的从节点。")])]),s._v(" "),t("p",[t("strong",[s._v("2）Sentinel领导者节点会对第一步选出来的从节点执行salveof no one命令让其称为主节点")])]),s._v(" "),t("p",[t("strong",[s._v("3）Sentinel领导者节点会向剩余的从节点发送命令，让他们成为新从节点的从节点，复制规则和parallel-syncs相关")])])])}),[],!1,null,null,null);n.default=e.exports}}]);