(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{462:function(s,n,a){"use strict";a.r(n);var t=a(11),e=Object(t.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"docker-swarm"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-swarm"}},[s._v("#")]),s._v(" Docker Swarm")]),s._v(" "),a("h2",{attrs:{id:"_1-单节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-单节点"}},[s._v("#")]),s._v(" 1. 单节点")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看swarm激活状态")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" info\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#Swarm: inactive")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 激活swarm")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" swarm init "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Swarm: inactive")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看结点信息")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加入结点")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" swarm "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" --token SWMTKN-1-42fgufb0zrr4k72eh78k9oa8qlgsfvbuzm418tg8rkfoh8ec12-1xzie5n0rd2ab809om9tfh9l6 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.130")]),s._v(".16.119:2377\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 退出集群")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" swarm leave --force\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建service")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" create\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 列出services")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示详细信息")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("SERVICEID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 复制多个service")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" update "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("SERVICEID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" --replicas "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("NUM"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#docker service update x4s --replicas 3")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除service")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("SERVICEID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br")])]),a("p",[a("strong",[s._v("docker swarm init背后发生了什么")])]),s._v(" "),a("p",[s._v("主要是PKI和安全相关的自动化")]),s._v(" "),a("ul",[a("li",[s._v("创建swarm集群的根证书")]),s._v(" "),a("li",[s._v("manager结点的证书")]),s._v(" "),a("li",[s._v("其他节点加入集群需要的tokens")])]),s._v(" "),a("p",[s._v("创建Raft数据库用于存储证书，配置，密码等数据")]),s._v(" "),a("h2",{attrs:{id:"_2-多节点集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-多节点集群"}},[s._v("#")]),s._v(" 2. 多节点集群")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 初始化swarm")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" swarm init\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加入swarm")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" swarm "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" --token SWMTKN-1-38v1jkv3fjqhz9j72p2il4i30nhgxrjfvbsh1z56hy9j9if7f5-eo3axzmazx7t00obnd211hpov "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("139.198")]),s._v(".175.236:2377\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在manager节点上创建service")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" create --name web nginx\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 复制三份")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" update web --replicas "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 水平扩展")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" scale "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("web")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建overlay网络")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" network create -d overlay mynet\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建服务")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" create --network mynet --name "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" --replicas "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" busybox "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.8")]),s._v(".8.8\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 抓包")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" tcpdump -i enp0s8 port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4789")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 4789 vxlan")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("h2",{attrs:{id:"_3-网络"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-网络"}},[s._v("#")]),s._v(" 3. 网络")]),s._v(" "),a("h3",{attrs:{id:"_3-1-overlay网络"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-overlay网络"}},[s._v("#")]),s._v(" 3.1 overlay网络")]),s._v(" "),a("p",[a("strong",[s._v("容器内部访问")])]),s._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://mynotes-1252832980.cos.ap-shanghai.myqcloud.com/image-20220319145246818.png"}}),s._v(" "),a("h3",{attrs:{id:"_3-1-ingress-网络"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-ingress-网络"}},[s._v("#")]),s._v(" 3.1 ingress 网络")]),s._v(" "),a("blockquote",[a("p",[s._v("主要是为了实现把service的服务端口对外发布出去，让其能够被外部网络访问到")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" create --name web --network mynet -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8000")]),s._v(":80 --replicas "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" containous/whoami\n\niptables -nvL -t nat\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run -it --rm -v /var/run/docker/netns:/netns --privileged"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true nicolaka/netshoot nsenter --net"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/netns/ingress_sbox "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])])])}),[],!1,null,null,null);n.default=e.exports}}]);