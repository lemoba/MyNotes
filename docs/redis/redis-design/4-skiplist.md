# 跳表

> 跳表(skiplist)是一种有序数据结构，它通过在每个节点中维持多个指向其他节点的指针，从而达到快速访问节点的目的。
>
> 时间复杂度：平均O(logN)  最快O(N)

**优点**

在大部分情况下，跳表的效率可以和平衡树相媲美，并且跳表的实现比平衡树来更简单。

**应用**

* Redis使用跳表来作为有序集合键的底层实现之一，如果一个有序集合包含的元素数量比较多，又或者有序集合中元素的成员(member)是比较长的字符串时，Redis就会使用跳表来作为有序集合键的底层实现。
* 集群节点中用作内部数据结构。

## 跳表的实现

> zskiplistNode用于表示跳表节点，zskiplist结构则用于保存跳表节点相关信息(节点数量，指向表头节点和表尾节点的指针 )     

<img src="https://mynotes-1252832980.cos.ap-shanghai.myqcloud.com/20220517115403.png" style="zoom:50%;" />                           

* **header**：指向跳跃表的表头节点
* **tail**：指向跳跃表的表尾节点
* **level**：跳表内，层数最大的那个节点的层数(不包括头节点)
* **length**：记录跳表的长度，也就是跳表包含的节点数(不包括头节点)
* **层**：用L1、L2...表示，每个层都带有两个属性，前进指针和跨度，前进指针用于访问位于表尾方向的其他节点，而跨度记录了当前节点与前进指针指向的节点间的距离
* **后退(backward)指针**：它执行当前节点的前一节点。在反向遍历时使用
* **分数(score)**：如1.0、2.0是节点所保存的分数。在跳表中，节点按各自所保存的分数从小到大排列
* **成员对象(obj)**：如o1、o2是节点所保存的成员对象

### 1 跳表的节点

**代码实现**

```c
// redis.h
typedef struct zskiplistNode {

    // 成员对象
    robj *obj;

    // 分值
    double score;

    // 后退指针
    struct zskiplistNode *backward;

    // 层
    struct zskiplistLevel {

        // 前进指针
        struct zskiplistNode *forward;

        // 跨度
        unsigned int span;

    } level[];

} zskiplistNode;

```

**层**

* 跳表的level数组可以包含多个元素，每个元素都包含一个指向其他节点的指针，一般来说，层的数量越多，访问其他节点的速度就越快
* 在创建新跳表节点时，程序根据**幂次定律**(越大的数出现的概率越小)，随机生成1-32的数作为level数组的大小，也就是层的"高度"

**前进指针**

* 每一层都有一个指向表尾方向的前进指针(level[i].forward)，用于从表头向表尾方向访问节点
* 如上图所示，遍历步骤如下：
    * 迭代程序首先访问跳表的头结点，然后从L4的前进指针移动到第二个节点
    * 在第二个结点，程序沿着L2的前进指针移动到第三个节点
    * 在第三个节点，程序沿着L2的前进指针移动到第四个节点
    * 直到遇到NULL则表示已遍历至表尾

**跨度**

* 层的跨度(level[i].span属性)用于记录两节点间的距离：

    * 两个节点间的跨度越大，它们相距得就越远

    * 指向 NULL的所有前进指针的跨度都为0

* 跨度与遍历操作无关，它是用来计排位(rank)的：在查找某个节点的过程中，将沿途访问过的所有层的跨度累计起来，就能得到目标节点在跳表中的排位

**后退指针**

后退指针用于从表尾向表头方向访问节点：跟前进指针一次可以跳过多个节点不一样，后退指针一次只能后退一个节点

**分值和成员**

* 节点的分值(score)是一个double类型的浮点数，跳表中的所有节点都按分值从小到大排序的
* 节点的成员对象(obj属性)是一个指针，它执行一个字符串对象，而字符串对象则保存着一个SDS值
* 在同一个跳表中，各节点保存的成员对象必须是唯一的，但是多个节点保存的分值却可以是相同的：**分值相同**的节点将按照成员对象在**字典序**中的大小来进行**排序**



### 2 跳表

**代码实现**

```c
typedef struct zskiplist {

    // 表头节点和表尾节点
    struct zskiplistNode *header, *tail;

    // 表中节点的数量
    unsigned long length;

    // 表中层数最大的节点的层数
    int level;

} zskiplist;
```

* header和tail指针分别指向跳表的表头和表尾结节点，可通过O(1)的复杂度快速定位到表头和表尾
* length属性记录节点的数量，O(1)复杂度内获取跳表长度
* level属性在O(1)复杂度内获取跳表中层高最大的那个节点的层数量(不含头节点)
